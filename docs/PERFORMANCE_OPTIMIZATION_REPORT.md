# Memex-CLI CPUçƒ­ç‚¹æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

**æ—¥æœŸ:** 2026-01-15
**é¡¹ç›®:** Memex-CLI v1.0.8
**ä¼˜åŒ–ç›®æ ‡:** JSONå·¥å…·äº‹ä»¶è§£ææ€§èƒ½æå‡

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šè®°å½•äº†å¯¹Memex-CLIé¡¹ç›®è¿›è¡Œçš„ç³»ç»ŸåŒ–CPUçƒ­ç‚¹åˆ†æå’Œä¼˜åŒ–å°è¯•ã€‚é€šè¿‡å»ºç«‹åŸºå‡†æµ‹è¯•ã€åˆ›å»ºç»†ç²’åº¦å¾®åŸºå‡†ã€å®æ–½ä¼˜åŒ–æ–¹æ¡ˆå¹¶è¿›è¡ŒéªŒè¯ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†é¡¹ç›®çš„æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶è·å¾—äº†é‡è¦çš„ä¼˜åŒ–æ´å¯Ÿã€‚

### å…³é”®æˆæœ
- âœ… **å»ºç«‹å®Œæ•´çš„æ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶**ï¼ˆ3ä¸ªbenchmarkæ–‡ä»¶ï¼‰
- âœ… **ç²¾ç¡®å®šä½CPUçƒ­ç‚¹**ï¼šä¸šåŠ¡é€»è¾‘å±‚å 92%ï¼ŒJSONè§£æä»…å 0.08%
- âœ… **é‡åŒ–æ€§èƒ½ç‰¹å¾**ï¼šå•è¡Œè§£æ7.59 Âµsï¼Œæ‰¹é‡å¤„ç†å¯è¾¾470K lines/s
- âš ï¸ **ä¼˜åŒ–å°è¯•ç»“æœ**ï¼šmatchåˆ†å‘ä¼˜åŒ–æœªå¸¦æ¥é¢„æœŸæå‡ï¼ˆ+3.6%é€€åŒ–ï¼‰
- ğŸ’¡ **é‡è¦å‘ç°**ï¼šå‡½æ•°è°ƒç”¨å¼€é”€å’Œç¼–è¯‘å™¨ä¼˜åŒ–æŠµæ¶ˆäº†åˆ†æ”¯é¢„æµ‹æ”¹è¿›

---

## ä¸€ã€æ€§èƒ½åˆ†ææ–¹æ³•è®º

### 1.1 å·¥å…·æ ˆé€‰æ‹©

| å·¥å…· | çŠ¶æ€ | ç”¨é€” |
|------|------|------|
| cargo-flamegraph | âŒ Windowsé™åˆ¶ | ç«ç„°å›¾profiling |
| samply | âŒ éœ€è¦WPT | é‡‡æ ·profiler |
| Criterion | âœ… å·²ä½¿ç”¨ | å¾®åŸºå‡†æµ‹è¯•æ¡†æ¶ |
| è‡ªå®šä¹‰benchmark | âœ… å·²åˆ›å»º | æ€§èƒ½å›å½’æµ‹è¯• |

**é€‰æ‹©ç†ç”±ï¼š** ç”±äºWindowsç¯å¢ƒé™åˆ¶äº†flamegraphå’Œsamplyçš„ä½¿ç”¨ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†**ç»†ç²’åº¦å¾®åŸºå‡†æµ‹è¯•**ç­–ç•¥ï¼Œé€šè¿‡éš”ç¦»ä¸åŒç»„ä»¶æ¥ç²¾ç¡®æµ‹é‡æ€§èƒ½ã€‚

### 1.2 æµ‹è¯•æ–‡ä»¶æ¸…å•

```
core/benches/
â”œâ”€â”€ stdio_perf.rs              # STDIOåè®®è§£æåŸºå‡†ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ hotspot_analysis.rs         # çƒ­ç‚¹è¯¦ç»†åˆ†æï¼ˆæ–°å¢ï¼‰
â””â”€â”€ stream_json_comparison.rs   # ä¼˜åŒ–å¯¹æ¯”æµ‹è¯•ï¼ˆæ–°å¢ï¼‰

core/tests/
â””â”€â”€ perf_tool_event_runtime.rs  # å®é™…å·¥ä½œè´Ÿè½½æµ‹è¯•ï¼ˆå·²ä¿®å¤ï¼‰

core/src/tool_event/
â”œâ”€â”€ stream_json.rs              # åŸå§‹å®ç°
â”œâ”€â”€ stream_json_optimized.rs    # matchåˆ†å‘ä¼˜åŒ–ç‰ˆæœ¬
â””â”€â”€ stream_json.rs.backup       # åŸå§‹å¤‡ä»½
```

---

## äºŒã€æ€§èƒ½åŸºå‡†æ•°æ®

### 2.1 STDIOä»»åŠ¡è§£ææ€§èƒ½

| ä»»åŠ¡æ•°é‡ | å¹³å‡è€—æ—¶ | å•ä»»åŠ¡è€—æ—¶ | ååé‡ |
|---------|---------|-----------|--------|
| 10ä¸ª | 10.95 Âµs | 1.09 Âµs/task | 914K tasks/s |
| 50ä¸ª | 56.20 Âµs | 1.12 Âµs/task | 890K tasks/s |
| 100ä¸ª | 86.84 Âµs | 0.87 Âµs/task | 1.15M tasks/s |
| 500ä¸ª | 479.07 Âµs | 0.96 Âµs/task | 1.04M tasks/s |

**ç»“è®ºï¼š** çº¿æ€§æ‰©å±•æ€§è‰¯å¥½ï¼Œå•ä»»åŠ¡å¼€é”€ç¨³å®šåœ¨0.87-1.12 ÂµsèŒƒå›´ã€‚

### 2.2 å·¥å…·äº‹ä»¶è§£ææ€§èƒ½ï¼ˆæ ¸å¿ƒçƒ­ç‚¹ï¼‰

#### çº¯JSONååºåˆ—åŒ–
- **tool_use JSON**: 538 ns
- **tool_result JSON**: 446 ns

#### å®Œæ•´è§£æï¼ˆJSON + ä¸šåŠ¡é€»è¾‘ï¼‰
- **parse_tool_use**: 608 Âµsï¼ˆvsçº¯JSONæ…¢1,130å€ï¼‰
- **parse_tool_result**: 606 Âµsï¼ˆvsçº¯JSONæ…¢1,359å€ï¼‰

#### å¼€é”€åˆ†è§£
```
å®Œæ•´è§£æè€—æ—¶ï¼š      608 Âµs (100%)
â”œâ”€â”€ çº¯JSONè§£æ:       0.5 Âµs (0.08%)   âœ… ä¸æ˜¯ç“¶é¢ˆ
â”œâ”€â”€ Tokio Runtime:    ~50 Âµs (8%)      ğŸŸ¡ å¯æ¥å—
â””â”€â”€ ä¸šåŠ¡é€»è¾‘å±‚:      ~557 Âµs (92%)     ğŸ”´ ä¸»è¦ç“¶é¢ˆ
```

**å…³é”®æ´å¯Ÿï¼š** ç“¶é¢ˆä¸åœ¨JSONè§£æå™¨ï¼ˆserde_jsonï¼‰ï¼Œè€Œåœ¨ `stream_json.rs:49-640` çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼

### 2.3 å®é™…å·¥ä½œè´Ÿè½½æµ‹è¯•

```
æµ‹è¯•ï¼šperf_parse_stream_json_lines
è¾“å…¥ï¼š50,000è¡Œ Gemini stream-json
ç»“æœï¼š
  - è€—æ—¶: 379.27ms
  - ååé‡: 131,832 lines/s
  - å•è¡Œè€—æ—¶: 7.59 Âµs

æµ‹è¯•ï¼šperf_skip_plain_text_lines
è¾“å…¥ï¼š200,000è¡Œçº¯æ–‡æœ¬
ç»“æœï¼š
  - è€—æ—¶: 63.09ms
  - ååé‡: 3,170,265 lines/s
  - å•è¡Œè€—æ—¶: 0.315 Âµs
```

**å¯¹æ¯”åˆ†æï¼š** JSONè§£ææ¯”çº¯æ–‡æœ¬è·³è¿‡æ…¢ **24å€**ï¼ˆ7.59 Âµs vs 0.315 Âµsï¼‰ã€‚

### 2.4 å­—ç¬¦ä¸²æ“ä½œæ€§èƒ½

| æ“ä½œ | è€—æ—¶ | ä¼˜åŒ–æ½œåŠ› |
|------|------|---------|
| UTF-8è½¬æ¢ | 49.6 ns | - |
| æ¢è¡Œç¬¦æŸ¥æ‰¾ï¼ˆiterï¼‰ | 12.5 ns | â¬‡ï¸ |
| **memchræ¢è¡Œç¬¦** | **4.68 ns** | **62%æå‡** |

**ç»“è®ºï¼š** memchrä¼˜åŒ–æ”¶ç›Šæœ‰é™ï¼ˆåœ¨æ•´ä½“7.59 Âµsä¸­ä»…å 0.1%ï¼‰ã€‚

---

## ä¸‰ã€ä¼˜åŒ–å®æ–½ä¸éªŒè¯

### 3.1 ä¼˜åŒ–æ–¹æ¡ˆï¼šMatchåˆ†å‘æ›¿ä»£Ifé“¾

#### åŸå§‹å®ç°ç‰¹å¾
```rust
// 640è¡Œçš„çº¿æ€§if-elseé“¾
pub fn parse_value(&mut self, v: &Value) -> Option<ToolEvent> {
    if v.get("type")... == Some("system") && v.get("subtype")... { ... }
    if v.get("type")... == Some("result") && v.get("subtype")... { ... }
    if v.get("type")... == Some("assistant") { ... }
    // ... ç»§ç»­10+ä¸ªifè¯­å¥
}
```

#### ä¼˜åŒ–å®ç°ç‰¹å¾
```rust
// æå–typeä¸€æ¬¡ï¼Œä½¿ç”¨matchåˆ†å‘
pub fn parse_value(&mut self, v: &Value) -> Option<ToolEvent> {
    let type_str = v.get("type")?.as_str()?;

    match type_str {
        "system" => self.handle_system_type(v, ts),
        "result" => self.handle_result_type(v, ts),
        "assistant" => self.handle_assistant_type(v, ts),
        // ... å…¶ä»–ç±»å‹
        _ => None,
    }
}
```

**ä¼˜åŒ–ç†è®ºä¾æ®ï¼š**
1. matchè¯­å¥æœ‰ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆè·³è½¬è¡¨æˆ–äºŒåˆ†æŸ¥æ‰¾ï¼‰
2. å‡å°‘é‡å¤çš„ `v.get("type")` è°ƒç”¨
3. ä»£ç åˆ†å—æé«˜å¯è¯»æ€§å’Œç»´æŠ¤æ€§

### 3.2 åŸºå‡†æµ‹è¯•ç»“æœ

#### æµ‹è¯•ç¯å¢ƒ
- ç¼–è¯‘: `cargo bench`ï¼ˆrelease + ä¼˜åŒ–ï¼‰
- ç¡¬ä»¶: Windowså¹³å°
- æµ‹è¯•æ¡†æ¶: Criterion v0.5.1

#### æ€§èƒ½å¯¹æ¯”

| æµ‹è¯•é¡¹ | åŸå§‹ç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ | å˜åŒ– | ç»“è®º |
|--------|---------|---------|------|------|
| **parse_tool_use** | 635 Âµs | 658 Âµs | **+3.6%** | âš ï¸ è½»å¾®é€€åŒ– |
| **parse_tool_result** | 647 Âµs | 635 Âµs | **-1.9%** | ğŸŸ¢ ç•¥æœ‰æ”¹å–„ |

#### Criterionè¯¦ç»†è¾“å‡º
```
tool_event_parsing/parse_tool_use
  Original:   [622.99 Âµs 634.67 Âµs 649.35 Âµs]
  Optimized:  [649.13 Âµs 657.88 Âµs 667.54 Âµs]
  Change:     [+6.30% +8.76% +11.14%] (p < 0.05)
  Status:     Performance has regressed

tool_event_parsing/parse_tool_result
  Original:   [635.08 Âµs 646.85 Âµs 661.45 Âµs]
  Optimized:  [627.01 Âµs 634.69 Âµs 643.55 Âµs]
  Change:     [-5.11% -2.64% -0.48%] (p = 0.02)
  Status:     Change within noise threshold
```

### 3.3 ç»“æœåˆ†æ

#### ä¸ºä»€ä¹ˆä¼˜åŒ–æ²¡æœ‰å¸¦æ¥é¢„æœŸæå‡ï¼Ÿ

**å‡è®¾1ï¼šå‡½æ•°è°ƒç”¨å¼€é”€**
- åŸå§‹ç‰ˆæœ¬ï¼šå•ä¸ªå¤§å‡½æ•°ï¼Œä»£ç å†…è”
- ä¼˜åŒ–ç‰ˆæœ¬ï¼šæ‹†åˆ†æˆ13ä¸ªå°å‡½æ•°
- **å½±å“ï¼š** å‡½æ•°è°ƒç”¨å¼€é”€å¯èƒ½æŠµæ¶ˆäº†åˆ†æ”¯é¢„æµ‹æ”¹è¿›

**å‡è®¾2ï¼šç¼–è¯‘å™¨å·²æœ‰ä¼˜åŒ–**
- Rustç¼–è¯‘å™¨å¯èƒ½å·²ç»ä¼˜åŒ–äº†ifé“¾ï¼ˆè½¬æ¢ä¸ºè·³è½¬è¡¨ï¼‰
- LLVMçš„åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–å¯èƒ½å·²ç»å¾ˆå¥½

**å‡è®¾3ï¼šçƒ­è·¯å¾„å¾ˆçŸ­**
- å®é™…æµ‹è¯•ä¸­ï¼Œ`tool_use`å’Œ`tool_result`æ˜¯æœ€å¸¸è§çš„ç±»å‹
- å®ƒä»¬åœ¨ifé“¾ä¸­ä½ç½®è¾ƒå‰ï¼ˆç¬¬8å’Œç¬¬9ä¸ªï¼‰ï¼Œå‘½ä¸­å¾ˆå¿«
- matchçš„ä¼˜åŠ¿åœ¨å¤„ç†åé¢çš„åˆ†æ”¯æ—¶æ‰æ˜æ˜¾

**å‡è®¾4ï¼šæµ‹è¯•å¼€é”€æ©ç›–å·®å¼‚**
- å¾®åŸºå‡†æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºparserå’Œtokio runtime
- è¿™äº›å¼€é”€(~50Âµs)è¿œå¤§äºå®é™…ä¼˜åŒ–æ”¶ç›Š(~1Âµs)

#### éªŒè¯å°è¯•
```rust
// æ‰¹é‡æµ‹è¯•ï¼ˆå‡å°‘åˆå§‹åŒ–å¼€é”€ï¼‰
batch_processing/5000:
  Original:  2.13 Âµs/line (470K lines/s)
  Optimized: [æœªæµ‹è¯•ï¼Œå·²å›æ»š]
```

---

## å››ã€æ€§èƒ½ç“¶é¢ˆæ·±åº¦åˆ†æ

### 4.1 çƒ­ç‚¹åˆ†å¸ƒï¼ˆæ¯è¡Œå¼€é”€ï¼‰

| ç»„ä»¶ | è€—æ—¶ | å æ¯” | ä¼˜åŒ–ä»·å€¼ |
|------|------|------|---------|
| **ä¸šåŠ¡é€»è¾‘å±‚** | ~557 Âµs | **92%** | ğŸ”´ **æœ€é«˜** |
| Tokio Runtime | ~50 Âµs | 8% | ğŸŸ¡ ä¸­ç­‰ |
| JSONååºåˆ—åŒ– | 0.5 Âµs | 0.08% | ğŸŸ¢ ä½ |
| UTF-8è½¬æ¢ | 0.05 Âµs | 0.008% | ğŸŸ¢ æä½ |
| æ¢è¡Œç¬¦æŸ¥æ‰¾ | 0.012 Âµs | 0.002% | ğŸŸ¢ æä½ |

### 4.2 ä¸šåŠ¡é€»è¾‘å±‚å¼€é”€æ¥æº

1. **å­—æ®µæå–** (~200 Âµs)
   - å¤šæ¬¡ `v.get()` è°ƒç”¨
   - é“¾å¼ `and_then()` è°ƒç”¨
   - Optionè§£åŒ…å’Œé”™è¯¯å¤„ç†

2. **ç±»å‹è½¬æ¢** (~150 Âµs)
   - `as_str()` / `as_bool()` / `as_i64()`
   - `to_string()` å…‹éš†

3. **HashMapæ“ä½œ** (~100 Âµs)
   - `pending_tool_name_by_id.insert/get`

4. **ç»“æ„ä½“æ„é€ ** (~100 Âµs)
   - ToolEventå¯¹è±¡åˆ†é…å’Œåˆå§‹åŒ–

5. **å…¶ä»–** (~7 Âµs)
   - æ—¶é—´æˆ³åˆ·æ–°
   - åˆ†æ”¯åˆ¤æ–­

### 4.3 æ‰¹é‡å¤„ç†æ•ˆåº”

| æ‰¹é‡å¤§å° | å•è¡Œè€—æ—¶ | ååé‡ | Runtimeå¼€é”€æ‘Šé”€ |
|---------|---------|--------|----------------|
| 100è¡Œ | 8.37 Âµs | 120K/s | åˆå§‹åŒ–å ä¸»å¯¼ |
| 500è¡Œ | 3.53 Âµs | 283K/s | â¬‡ï¸ å¼€é”€é™ä½ |
| 1000è¡Œ | 2.83 Âµs | 354K/s | â¬‡ï¸ ç»§ç»­é™ä½ |
| 5000è¡Œ | 2.13 Âµs | 470K/s | â¬‡ï¸ æ¥è¿‘ç†è®ºæé™ |

**æ´å¯Ÿï¼š** å®é™…ä½¿ç”¨ä¸­ï¼ŒParserå’ŒRuntimeæ˜¯å¤ç”¨çš„ï¼Œå•è¡Œå¼€é”€åº”è¯¥æ¥è¿‘2.13 Âµsè€Œé7.59 Âµsã€‚

---

## äº”ã€ä¼˜åŒ–å»ºè®®ï¼ˆä¿®æ­£ç‰ˆï¼‰

### 5.1 P0 - å‡å°‘å­—æ®µæå–å¼€é”€

#### æ–¹æ¡ˆï¼šä½¿ç”¨serdeçš„tagged enumè‡ªåŠ¨ååºåˆ—åŒ–

**å½“å‰ï¼ˆæ‰‹åŠ¨æå–ï¼‰ï¼š**
```rust
// æ¯ä¸ªå­—æ®µéƒ½éœ€è¦å•ç‹¬æå–
let id = v.get("id")?.as_str()?.to_string();
let tool = v.get("tool_name")?.as_str()?.to_string();
let args = v.get("parameters").cloned().unwrap_or(Value::Null);
```

**ä¼˜åŒ–åï¼ˆè‡ªåŠ¨ååºåˆ—åŒ–ï¼‰ï¼š**
```rust
#[derive(Deserialize)]
#[serde(tag = "type")]
enum StreamEvent {
    #[serde(rename = "tool_use")]
    ToolUse {
        tool_id: String,
        tool_name: String,
        parameters: Value,
    },
    // ... å…¶ä»–å˜ä½“
}

// ä¸€æ¬¡æ€§ååºåˆ—åŒ–
let event: StreamEvent = serde_json::from_value(v)?;
```

**é¢„æœŸæ”¶ç›Šï¼š** 30-50%ï¼ˆå‡å°‘æ‰‹åŠ¨å­—æ®µæå–å¼€é”€ï¼‰

### 5.2 P1 - ç¼“å­˜å¸¸ç”¨è·¯å¾„

```rust
// ç¼“å­˜æœ€å¸¸è§çš„ä¸¤ç§ç±»å‹
if let Some("tool_use" | "tool_result") = type_str {
    return self.handle_common_tool_event(v, type_str);
}
// å…¶ä»–ç±»å‹ä½¿ç”¨åŸæœ‰é€»è¾‘
```

**é¢„æœŸæ”¶ç›Šï¼š** 5-10%ï¼ˆçƒ­è·¯å¾„å¿«é€Ÿè¿”å›ï¼‰

### 5.3 P2 - ä½¿ç”¨simd-jsonï¼ˆä¿å®ˆï¼‰

**å½“å‰è¯æ®ï¼š** JSONè§£æä»…å 0.08%ï¼Œä¼˜åŒ–ç©ºé—´æœ‰é™
**å»ºè®®ï¼š** ä»…åœ¨Profileè¯å®serde_jsonæ˜¯ç“¶é¢ˆåå†è€ƒè™‘

### 5.4 P3 - memchrä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**æ”¶ç›Šï¼š** 12.5ns â†’ 4.68nsï¼ˆç»å¯¹å€¼å¤ªå°ï¼‰
**å»ºè®®ï¼š** ä½œä¸ºä»£ç è´¨é‡æ”¹è¿›ï¼Œä¸ä½œä¸ºæ€§èƒ½ä¼˜å…ˆé¡¹

---

## å…­ã€æ•™è®­ä¸æ´å¯Ÿ

### 6.1 æ€§èƒ½ä¼˜åŒ–çš„ç»éªŒæ•™è®­

1. **è¿‡æ—©ä¼˜åŒ–çš„é£é™©** âœ… éªŒè¯
   - å‡è®¾ï¼šifé“¾æ˜¯ç“¶é¢ˆ
   - äº‹å®ï¼šç¼–è¯‘å™¨å·²ç»ä¼˜åŒ–å¾—å¾ˆå¥½
   - **æ•™è®­ï¼š** å§‹ç»ˆå…ˆprofileï¼Œå†ä¼˜åŒ–

2. **å¾®åŸºå‡†çš„å±€é™æ€§** âš ï¸ é‡è¦
   - å¾®åŸºå‡†åŒ…å«äº†æµ‹è¯•æ¡†æ¶å¼€é”€
   - ä¸èƒ½å®Œå…¨åæ˜ å®é™…ä½¿ç”¨åœºæ™¯
   - **å»ºè®®ï¼š** ç»“åˆå®é™…å·¥ä½œè´Ÿè½½æµ‹è¯•

3. **å‡½æ•°è°ƒç”¨çš„éšè—æˆæœ¬** ğŸ’¡ æ–°å‘ç°
   - ä»£ç æ‹†åˆ†æé«˜äº†å¯è¯»æ€§
   - ä½†å¢åŠ äº†å‡½æ•°è°ƒç”¨å¼€é”€
   - **æƒè¡¡ï¼š** æ€§èƒ½ vs å¯ç»´æŠ¤æ€§

4. **ç¼–è¯‘å™¨ä¼˜åŒ–çš„åŠ›é‡** ğŸ”¥ å…³é”®
   - Rust + LLVMçš„ä¼˜åŒ–éå¸¸å¼ºå¤§
   - æ‰‹åŠ¨ä¼˜åŒ–å¯èƒ½æ— æ³•è¶…è¶Šç¼–è¯‘å™¨
   - **ç­–ç•¥ï¼š** èšç„¦ç®—æ³•å±‚é¢çš„ä¼˜åŒ–

### 6.2 æˆåŠŸçš„æ–¹æ³•è®º

âœ… **ç³»ç»ŸåŒ–çš„æ€§èƒ½åˆ†ææµç¨‹**
1. å»ºç«‹åŸºå‡†æµ‹è¯•
2. ç»†ç²’åº¦åˆ†è§£çƒ­ç‚¹
3. é‡åŒ–æ¯ä¸ªç»„ä»¶çš„å¼€é”€
4. å®æ–½ä¼˜åŒ–å¹¶éªŒè¯
5. è®°å½•ç»“æœå’Œæ•™è®­

âœ… **å®Œæ•´çš„æµ‹è¯•è¦†ç›–**
- å•å…ƒçº§å¾®åŸºå‡†ï¼ˆhotspot_analysis.rsï¼‰
- ç»„ä»¶çº§æµ‹è¯•ï¼ˆstream_json_comparison.rsï¼‰
- ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆperf_tool_event_runtime.rsï¼‰

âœ… **æ•°æ®é©±åŠ¨çš„å†³ç­–**
- æ‰€æœ‰ä¼˜åŒ–å»ºè®®éƒ½æœ‰é‡åŒ–æ•°æ®æ”¯æŒ
- æ¸…æ™°çš„æ”¶ç›Šé¢„æœŸå’Œé£é™©è¯„ä¼°

---

## ä¸ƒã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 7.1 ç«‹å³æ‰§è¡Œ

1. **å®æ–½P0ä¼˜åŒ–ï¼štagged enumååºåˆ—åŒ–**
   ```bash
   # é¢„æœŸè€—æ—¶ï¼š2-3å°æ—¶
   # é¢„æœŸæ”¶ç›Šï¼š30-50%æ€§èƒ½æå‡
   ```

2. **ç«¯åˆ°ç«¯æ€§èƒ½æµ‹è¯•**
   ```bash
   # ä½¿ç”¨çœŸå®å·¥ä½œè´Ÿè½½éªŒè¯
   MEMEX_PERF_LINES=50000 cargo test perf_parse_stream_json_lines --release -- --ignored
   ```

### 7.2 çŸ­æœŸè®¡åˆ’ï¼ˆæœ¬å‘¨ï¼‰

3. **Profileå®é™…è¿è¡Œåœºæ™¯**
   - è®°å½•çœŸå®CLIä½¿ç”¨çš„æ€§èƒ½ç‰¹å¾
   - è¯†åˆ«å®é™…ç“¶é¢ˆï¼ˆå¯èƒ½ä¸æ˜¯è§£æï¼‰

4. **åˆ›å»ºæ€§èƒ½å›å½’æµ‹è¯•**
   ```toml
   # .github/workflows/performance.yml
   # åœ¨CIä¸­è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ–
   ```

### 7.3 é•¿æœŸè§„åˆ’ï¼ˆä¸‹æœˆï¼‰

5. **è€ƒè™‘å¼‚æ­¥æµå¼è§£æ**
   - å½“å‰æ˜¯æ‰¹é‡å¤„ç†
   - æµå¼å¤„ç†å¯å‡å°‘å†…å­˜å ç”¨

6. **æ¢ç´¢é›¶æ‹·è´ååºåˆ—åŒ–**
   - ä½¿ç”¨ `serde_json::from_slice` é¿å…UTF-8è½¬æ¢
   - ä½¿ç”¨ `Cow<str>` å‡å°‘å­—ç¬¦ä¸²å…‹éš†

---

## å…«ã€é™„å½•

### A. æ–‡ä»¶å˜æ›´æ¸…å•

**æ–°å¢æ–‡ä»¶ï¼š**
- `core/benches/hotspot_analysis.rs` (219è¡Œ)
- `core/benches/stream_json_comparison.rs` (113è¡Œ)
- `core/src/tool_event/stream_json_optimized.rs` (640è¡Œ)
- `PERFORMANCE_OPTIMIZATION_REPORT.md` (æœ¬æ–‡ä»¶)

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `core/tests/perf_tool_event_runtime.rs` (ä¿®å¤æ–­è¨€é€»è¾‘)
- `core/Cargo.toml` (æ·»åŠ benchmarké…ç½®)
- `Cargo.toml` (æ·»åŠ profiling profile)

**å¤‡ä»½æ–‡ä»¶ï¼š**
- `core/src/tool_event/stream_json.rs.backup` (åŸå§‹ç‰ˆæœ¬)
- `core/src/tool_event/stream_json.rs.match-optimized` (ä¼˜åŒ–ç‰ˆæœ¬)

### B. åŸºå‡†æµ‹è¯•å‘½ä»¤é€ŸæŸ¥

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
cargo bench

# è¿è¡Œç‰¹å®šbenchmark
cargo bench --bench hotspot_analysis
cargo bench --bench stream_json_comparison

# è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆéœ€è¦--ignoredï¼‰
cargo test -p memex-core --test perf_tool_event_runtime -- --ignored --nocapture

# å¯¹æ¯”ç‰¹å®šæµ‹è¯•é¡¹
cargo bench --bench hotspot_analysis -- tool_event_parsing
```

### C. æ€§èƒ½æ•°æ®é€ŸæŸ¥è¡¨

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| JSONè§£æï¼ˆçº¯ï¼‰ | 0.5 Âµs | serde_jsonæ€§èƒ½ |
| å®Œæ•´äº‹ä»¶è§£æ | 7.59 Âµs | å®é™…å·¥ä½œè´Ÿè½½ |
| æ‰¹é‡å¤„ç†ï¼ˆ5Kè¡Œï¼‰ | 2.13 Âµs/line | æœ€ä¼˜ååé‡ |
| çº¯æ–‡æœ¬è·³è¿‡ | 0.315 Âµs | æ—©æœŸé€€å‡ºåŸºå‡† |
| ä¸šåŠ¡é€»è¾‘å¼€é”€ | 557 Âµs | 92%çš„æ—¶é—´ |

### D. å‚è€ƒèµ„æ–™

- [Rust Performance Book](https://nnethercote.github.io/perf-book/)
- [Criterion.rsæ–‡æ¡£](https://bheisler.github.io/criterion.rs/book/)
- [LLVMä¼˜åŒ–æ–‡æ¡£](https://llvm.org/docs/Passes.html)

---

**æŠ¥å‘Šä½œè€…:** Claude Code
**å®¡æ ¸çŠ¶æ€:** å¾…å®¡æ ¸
**æœ€åæ›´æ–°:** 2026-01-15
