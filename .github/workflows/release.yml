name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: Generate release body
        env:
          TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          cat > release-notes.md <<EOF
          # Memex CLI ${TAG}

          这一版自动构建并上传多平台二进制，资产在本 Release 的 **Assets** 区域。

          ## 安装

          1. 下载对应平台的 `memex-cli`（Windows 为 `memex-cli.exe`）
          2. 放到 PATH（或在当前目录直接运行）

          ## 快速开始

          - 运行（示例）：
            ```bash
            memex-cli run \
              --backend codex \
              --backend-kind codecli \
              --prompt "帮我总结这个仓库的模块结构，并指出关键入口" \
              --stream
            ```

          - 回放：
            ```bash
            memex-cli replay --events ./run.events.jsonl --format text
            ```

          ## 配置

          程序会在当前工作目录读取 `config.toml`；也可用环境变量覆盖：

          - \\`MEM_CODECLI_PROJECT_ID\\`
          - \\`MEM_CODECLI_MEMORY_URL\\`
          - \\`MEM_CODECLI_MEMORY_API_KEY\\`

          详细说明见仓库 README 与 docs：
          - https://github.com/${REPO}
          - https://github.com/${REPO}/tree/main/docs
          EOF

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: release-notes.md
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build & Upload (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: create_release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build & upload memex-cli binary
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: memex-cli
          target: ${{ matrix.target }}
          manifest-path: cli/Cargo.toml
          archive: ${{ matrix.archive }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
