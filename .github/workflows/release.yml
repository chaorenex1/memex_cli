name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          echo "## ðŸš€ Release v${{ steps.version.outputs.VERSION }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“¦ Quick Install" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Linux / macOS:**" >> RELEASE_NOTES.md
          echo "\`\`\`bash" >> RELEASE_NOTES.md
          echo "curl -sSL https://github.com/chaorenex1/memex-cli/releases/latest/download/install_memex.sh | bash" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "**Windows (PowerShell):**" >> RELEASE_NOTES.md
          echo "\`\`\`powershell" >> RELEASE_NOTES.md
          echo "irm https://github.com/chaorenex1/memex-cli/releases/latest/download/install_memex.ps1 | iex" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“¦ Assets" >> RELEASE_NOTES.md
          echo "- \`install_memex.sh.tar.gz\` - Installer script for Linux/macOS" >> RELEASE_NOTES.md
          echo "- \`install_memex.ps1.zip\` - Installer script for Windows" >> RELEASE_NOTES.md
          echo "- \`memex-cli-aarch64-apple-darwin.tar.gz\` - macOS ARM64 (Apple Silicon)" >> RELEASE_NOTES.md
          echo "- \`memex-cli-x86_64-apple-darwin.tar.gz\` - macOS Intel" >> RELEASE_NOTES.md
          echo "- \`memex-cli-x86_64-unknown-linux-gnu.tar.gz\` - Linux x64" >> RELEASE_NOTES.md
          echo "- \`memex-cli-x86_64-pc-windows-msvc.zip\` - Windows x64" >> RELEASE_NOTES.md
          echo "- \`memex-env-scripts.tar.gz\` / \`.zip\` - Environment setup scripts" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“ Changes" >> RELEASE_NOTES.md
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "" >> RELEASE_NOTES.md
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          else
            echo "- Initial release" >> RELEASE_NOTES.md
          fi

      - uses: taiki-e/create-gh-release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "v${{ steps.version.outputs.VERSION }}"
          body-path: RELEASE_NOTES.md

  build:
    needs: create-release
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
            npm-dir: darwin-arm64
            binary: memex-cli
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            npm-dir: linux-x64
            binary: memex-cli
          - target: x86_64-apple-darwin
            os: macos-latest
            npm-dir: darwin-x64
            binary: memex-cli
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            npm-dir: win32-x64
            binary: memex-cli.exe
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Show version info
        run: |
          echo "Building memex-cli for ${{ matrix.target }}"
          echo "Git ref: ${{ github.ref }}"
          echo "Version: ${GITHUB_REF#refs/tags/v}"
        shell: bash

      - name: Install cross-compilation tools
        uses: taiki-e/setup-cross-toolchain-action@v1
        with:
          target: ${{ matrix.target }}
          runner: none
        if: startsWith(matrix.os, 'ubuntu')

      - uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: memex-cli
          target: ${{ matrix.target }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build release binary
        run: cargo build -p memex-cli --release --target ${{ matrix.target }}

      - name: Copy binary to npm package (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/memex-cli npm/${{ matrix.npm-dir }}/memex-cli
          chmod +x npm/${{ matrix.npm-dir }}/memex-cli

      - name: Copy binary to npm package (Windows)
        if: runner.os == 'Windows'
        run: |
          Copy-Item "target\${{ matrix.target }}\release\memex-cli.exe" "npm\${{ matrix.npm-dir }}\memex-cli.exe"

      - name: Copy memex-env scripts to npm package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p npm/${{ matrix.npm-dir }}/scripts
          cp memex-env.sh npm/${{ matrix.npm-dir }}/scripts/
          cp memex-env.ps1 npm/${{ matrix.npm-dir }}/scripts/
          cp memex-env.bat npm/${{ matrix.npm-dir }}/scripts/
          chmod +x npm/${{ matrix.npm-dir }}/scripts/memex-env.sh

      - name: Copy memex-env scripts to npm package (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -Path "npm\${{ matrix.npm-dir }}\scripts" -ItemType Directory -Force | Out-Null
          Copy-Item "memex-env.sh" "npm\${{ matrix.npm-dir }}\scripts\"
          Copy-Item "memex-env.ps1" "npm\${{ matrix.npm-dir }}\scripts\"
          Copy-Item "memex-env.bat" "npm\${{ matrix.npm-dir }}\scripts\"

      - name: Upload npm package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-${{ matrix.npm-dir }}
          path: npm/${{ matrix.npm-dir }}

  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare packages
        run: |
          # Copy binaries to npm package directories
          cp -r artifacts/npm-darwin-arm64/* npm/darwin-arm64/
          cp -r artifacts/npm-darwin-x64/* npm/darwin-x64/
          cp -r artifacts/npm-linux-x64/* npm/linux-x64/
          cp -r artifacts/npm-win32-x64/* npm/win32-x64/

          # Set executable permissions
          chmod +x npm/darwin-arm64/memex-cli || true
          chmod +x npm/darwin-x64/memex-cli || true
          chmod +x npm/linux-x64/memex-cli || true

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update package versions
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          for dir in npm/darwin-arm64 npm/darwin-x64 npm/linux-x64 npm/win32-x64 npm/memex-cli; do
            jq --arg v "$VERSION" '.version = $v' "$dir/package.json" > "$dir/package.json.tmp"
            mv "$dir/package.json.tmp" "$dir/package.json"
          done
          # Update optionalDependencies versions in main package
          jq --arg v "$VERSION" '.optionalDependencies = (.optionalDependencies | to_entries | map(.value = $v) | from_entries)' npm/memex-cli/package.json > npm/memex-cli/package.json.tmp
          mv npm/memex-cli/package.json.tmp npm/memex-cli/package.json

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for dir in npm/darwin-arm64 npm/darwin-x64 npm/linux-x64 npm/win32-x64; do
            cd $dir
            npm publish --access public || true
            cd ../..
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm/memex-cli
          npm publish --access public

      - name: Package memex-env scripts for release
        run: |
          mkdir -p release-artifacts/scripts
          mkdir -p release-artifacts/installer
          cp memex-env.sh memex-env.ps1 memex-env.bat release-artifacts/scripts/
          cp install_memex.sh install_memex.bat install_memex.ps1 release-artifacts/installer/
          cd release-artifacts
          tar -czf memex-env-scripts.tar.gz scripts/
          zip -r memex-env-scripts.zip scripts/

      - name: Upload memex-env scripts to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/installer/install_memex.sh
            release-artifacts/installer/install_memex.bat
            release-artifacts/installer/install_memex.ps1
            release-artifacts/memex-env-scripts.tar.gz
            release-artifacts/memex-env-scripts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
