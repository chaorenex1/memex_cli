# Memex-CLI Configuration Template
#
# This is an EXAMPLE configuration file showing all available options with their DEFAULT values.
# Values shown here match the defaults in core/src/config/types.rs (Single Source of Truth).
#
# Configuration loading priority:
#   1. ~/.memex/config.toml (highest priority)
#   2. ./config.toml (current directory)
#   3. Built-in defaults (if no config file exists)
#
# You can:
#   - Copy this file to ~/.memex/config.toml and customize it
#   - Omit any section to use built-in defaults
#   - Override specific values while keeping others at default
#
# NOTE: All values below are DEFAULTS. Delete or comment out sections you don't need to change.

[control]
# Default values (defined in core/src/config/types.rs)
fail_mode = "closed"
decision_timeout_ms = 300000
abort_grace_ms = 5000
line_tap_channel_capacity = 1024
control_channel_capacity = 128
control_writer_error_capacity = 1
tick_interval_ms = 1000

[logging]
# Default values (defined in core/src/config/types.rs)
# EnvFilter format: "info" / "debug" / "memex_core=debug,memex_cli=debug", etc.
level = "info"
# Output to stderr
console = true
# Output to file (defaults to system temp directory)
file = true
# directory = ""  # Empty/unset = use system temp directory

[policy]
# Default values (defined in core/src/config/types.rs)
provider = "config"
mode = "auto"
default_action = "deny"

denylist = [
  { tool = "shell.exec", action = "exec", reason = "shell is denied by default" },
  { tool = "net.http", action = "net", reason = "network is denied by default" },
]

allowlist = [
  { tool = "fs.read", action = "read", reason = "read is allowed" },
  { tool = "git.*", reason = "git commands allowed" },

  # 文件查看命令（只读，安全）
  { tool = "bash.ls", reason = "list files" },
  { tool = "bash.cat", reason = "view file contents" },
  { tool = "bash.head", reason = "view file head" },
  { tool = "bash.tail", reason = "view file tail" },
  { tool = "bash.less", reason = "view file with pager" },
  { tool = "bash.more", reason = "view file with pager" },

  # 搜索命令（只读，安全）
  { tool = "bash.grep", reason = "search file contents" },
  { tool = "bash.find", reason = "find files" },
  { tool = "bash.locate", reason = "locate files" },
  { tool = "bash.which", reason = "locate command" },
  { tool = "bash.whereis", reason = "locate binary/source/man" },

  # 目录操作（只读，安全）
  { tool = "bash.pwd", reason = "print working directory" },
  { tool = "bash.cd", reason = "change directory" },
  { tool = "bash.tree", reason = "display directory tree" },

  # 输出命令（安全）
  { tool = "bash.echo", reason = "print text" },
  { tool = "bash.printf", reason = "formatted print" },

  # 系统信息（只读，安全）
  { tool = "bash.date", reason = "show date/time" },
  { tool = "bash.cal", reason = "show calendar" },
  { tool = "bash.env", reason = "show environment" },
  { tool = "bash.printenv", reason = "print environment" },
  { tool = "bash.whoami", reason = "show current user" },
  { tool = "bash.hostname", reason = "show hostname" },
  { tool = "bash.uname", reason = "show system info" },

  # 文件信息（只读，安全）
  { tool = "bash.stat", reason = "file statistics" },
  { tool = "bash.file", reason = "determine file type" },
  { tool = "bash.wc", reason = "word count" },
  { tool = "bash.du", reason = "disk usage" },
  { tool = "bash.df", reason = "disk free space" },

  # 文本处理（安全）
  { tool = "bash.sort", reason = "sort lines" },
  { tool = "bash.uniq", reason = "unique lines" },
  { tool = "bash.cut", reason = "cut fields" },
  { tool = "bash.sed", reason = "stream editor" },
  { tool = "bash.awk", reason = "text processing" },
  { tool = "bash.tr", reason = "translate characters" },

  # 压缩/归档查看（只读操作）
  { tool = "bash.tar", reason = "archive operations (read-only)" },
  { tool = "bash.gzip", reason = "compression" },
  { tool = "bash.gunzip", reason = "decompression" },
  { tool = "bash.zip", reason = "zip operations" },
  { tool = "bash.unzip", reason = "unzip operations" },

  # 进程查看（只读，安全）
  { tool = "bash.ps", reason = "process status" },
  { tool = "bash.top", reason = "process monitor" },
  { tool = "bash.htop", reason = "interactive process viewer" },
]

[memory]
# Memory provider: "service" (remote HTTP), "local" (LanceDB), "hybrid" (local + sync)
provider = "service"
enabled = true

# ===== Service Provider (Remote HTTP API) =====
base_url = "https://memory.internal"
api_key = ""
timeout_ms = 10000
search_limit = 6
min_score = 0.2

# ===== Local Provider (LanceDB) =====
# Uncomment to use local storage (requires LanceDB implementation)
# db_path = "~/.memex/db"
# search_limit = 6
# min_score = 0.2
#
# [memory.embedding]
# provider = "ollama"  # Options: ollama | openai | local
#
# [memory.embedding.ollama]
# base_url = "http://localhost:11434"
# model = "nomic-embed-text"
# dimension = 768
#
# [memory.embedding.openai]
# base_url = "https://api.openai.com/v1"
# api_key = ""
# model = "text-embedding-3-small"
#
# [memory.embedding.local]
# model = "all-MiniLM-L6-v2"  # Options: all-MiniLM-L6-v2 | bge-small-en-v1.5
# device = "cpu"               # Options: cpu | cuda (NVIDIA GPU) | metal (Apple Silicon)
# dimension = 384              # Auto-detected from model if 0
# repo = "sentence-transformers"  # Hugging Face repo
#
# [memory.sync]
# enabled = true           # Enable automatic background sync
# interval_secs = 300      # Sync interval in seconds (5 minutes)
# batch_size = 50          # Upload batch size
# max_retries = 3          # Retry attempts on failure
# conflict_resolution = "last_write_wins"  # Options: last_write_wins | local_wins | remote_wins | manual

# ===== Hybrid Provider (Local + Remote Sync) =====
# Uncomment to use hybrid mode (not yet implemented)
# [memory.local]
# db_path = "~/.memex/db"
# search_limit = 6
# min_score = 0.2
#
# [memory.local.embedding]
# provider = "ollama"
#
# [memory.local.sync]
# enabled = true
# interval_secs = 300
#
# [memory.remote]
# base_url = "https://memory.internal"
# api_key = ""
# timeout_ms = 10000
#
# sync_strategy = "local_first"  # Options: local_first | remote_first

[prompt_inject]
# Default values (defined in core/src/config/types.rs)
placement = "user" # Options: system | user
max_items = 10
max_answer_chars = 1000
include_meta_line = true

[gatekeeper]
# Default values (defined in core/src/config/types.rs)
provider = "standard"
max_inject = 10
min_trust_show = 0.40
min_level_inject = 2
min_level_fallback = 1
block_if_consecutive_fail_ge = 3
skip_if_top1_score_ge = 0.85
digest_head_chars = 80
digest_tail_chars = 80
exclude_stale_by_default = true
active_statuses = ["active", "verified"]

[candidate_extract]
# Default values (defined in core/src/config/types.rs)
max_candidates = 10
max_answer_chars = 2000
min_answer_chars = 100
context_lines = 8
tool_steps_max = 5
tool_step_args_keys_max = 16
tool_step_value_max_chars = 140
redact = true
strict_secret_block = true
confidence = 0.45

[events_out]
# Default values (defined in core/src/config/types.rs)
enabled = true
path = "./run.events.jsonl"
channel_capacity = 2048
drop_when_full = true

[tui]
# Default values (defined in core/src/config/types.rs)
enabled = true
auto_scroll = true
show_splash = true
splash_duration_ms = 1500
splash_animation = true
update_interval_ms = 50
max_tool_events = 1000
max_output_lines = 10000

[http_server]
# Default values (defined in core/src/config/types.rs)
host = "127.0.0.1"
port = 8001
mode = "remote"        # "local"=直接调用Core, "remote"=通过HTTP调用Server

[stdio]
# Default values (defined in core/src/config/types.rs)
max_parallel_tasks = 4               # Base concurrency (recommend half of CPU cores)
enable_adaptive_concurrency = true   # Enable dynamic scheduling (Level 2.2)
enable_event_buffering = true        # Enable event batching (Level 2.1)
event_buffer_size = 50               # Event buffer size
event_flush_interval_ms = 100        # Flush interval (milliseconds)
enable_file_cache = false            # File cache (default off to avoid memory usage)
file_cache_size = 100                # Cache entries count
enable_mmap_large_files = true       # Use mmap for large files (Level 3.1)
mmap_threshold_mb = 10               # mmap threshold (MB)

[executor]
# Default values (defined in core/src/executor/types/config.rs)

[executor.file_processing]
enabled = true
enable_mmap = true
mmap_threshold_mb = 10
enable_cache = true
cache_size = 100
max_files = 100
max_total_size_mb = 200

[executor.output]
format = "jsonl"       # or "text"
pretty_print = false
ascii_only = false

[executor.retry]
strategy = "exponential-backoff"
base_delay_ms = 100
max_delay_ms = 5000
max_attempts = 3

[executor.concurrency]
strategy = "adaptive"
min_concurrency = 2
max_concurrency = 32
base_concurrency = 8
cpu_threshold_low = 50.0
cpu_threshold_high = 80.0
